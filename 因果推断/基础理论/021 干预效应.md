一旦定义好了干预变量，确定了每种干预状态下的潜在结果，我们就可以计算干预效应。

根据分析的不同层次，干预效应可分为两种：一种是个体层面的干预，二是总体层面的干预。

# 个体层面的干预效应

以二值干预为例，对任意个体 $i$ 来说，记干预状态（$D_i=1$）下的潜在结果为 $Y_i^1$ ，控制状态（$D_i=0$）下的潜在结果为 $Y_i^0$，我们可以通过二者之差来定义个体层面的干预效应，用公式表达为：

$$\delta_i=Y_i^1-Y_i^0$$

要计算个体层面的干预效应，研究者必须知道所有干预状态下的潜在结果，而这在现实情况下是不可能的。

## 现实情况下计算个体层面的干预效应

| 姓名  | $D_i$ | $Y_i^1$ | $Y_i^0$ | $\delta_i$ |
| :-: | :---: | :-----: | :-----: | :--------: |
| 张三  |   0   |    -    |  3000   |     ？      |
| 李四  |   1   |  3000   |    -    |     ？      |
| 王五  |   1   |  6000   |    -    |     ？      |
| 赵六  |   0   |    -    |  5600   |     ？      |
| 钱七  |   1   |  5600   |    -    |     ？      |
## 理想情况下计算个体层面的干预效应

| 姓名  | $D_i$ | $Y_i^1$ | $Y_i^0$ | $\delta_i$ |
| :-: | :---: | :-----: | :-----: | :--------: |
| 张三  |   0   |  4000   |  3000   |    1000    |
| 李四  |   1   |  3000   |  3000   |     0      |
| 王五  |   1   |  6000   |  4000   |    2000    |
| 赵六  |   0   |  5000   |  5600   |    -600    |
| 钱七  |   1   |  5600   |  4000   |    1600    |
从这里，我们是无法知道没个人的 $Y_i^1$ 和 $Y_i^0$ 的，也就是无法直接计算上大学对每个人收入的影响。

由于因果推断的根本难题，研究者无法直接计算个体层面的干预效应，只能在一定的假设条件下对其大小进行估计。这种估计的关键在于合理预测反事实状态下缺失的潜在结果，也正因如此，鲁宾认为：因果推断在本质上是一个缺失数据的填补问题。

除此之外，个体层面的干预效应 $\delta_i$ 有一个下表 $i$ ，这表示干预变量对因变量的影响会因人而异。

通过个体层面的干预效应，研究者可以很好的观察上大学对收入影响的异质性，但与此同时，研究者可能也会想在总体层面评估大学对收入的影响。

这时，我们就需要计算平均干预效应。

# 平均干预效应

平均干预效应是个体层面干预效应的平均值。在计算平均值之前，需要明确一个问题是：对谁求平均？
在具体的应用中，研究者通畅会计算三种不同的平均干预效应，它们分别对应三个不同的群体。

1. 总体的平均干预效应（ATE），对所有的研究对象求平均：
$$\delta_{ATE}=E(\delta_i)=E(Y_i^1-Y_i^0)$$

2. 干预组的平均干预效应（average treatment effect in the treated，ATT）
$$\delta_{ATT}=E(\delta_i|d_i=1)=E(Y_i^1-Y_i^0|D_i=1)$$

3. 控制组的平均干预效应（average treatment effect in the untreated，ATU）
$$\delta_{ATU}=E(\delta_i|d_i=0)=E(Y_i^1-Y_i^0|D_i=0)$$

个体层面的干预效应通畅存在异质性，所以ATE、ATT、ATU的值不会完全相等，而从三者的差异出发可以对一些竞争性的理论进行校验。

根据 [理想情况下计算个体层面的干预效应](#理想情况下计算个体层面的干预效应) 中的数据计算 ATE、ATT和ATU。

根据定义，ATE等于所有人 $\delta_i$ 的平均值，因此，将表中最后一列的5个 $\delta_i$ 取平均，可以得到 $\delta_{ATE} = 800$ 。
其次是 ATT，ATT表示考上大学的人的 $\delta_i$ 的平均值， 在上表中吗，有三个人考上了大学，分别是 李四、王五和钱七，取平均后得到 $\delta_{ATT}=1200$ 。
最后的 ATU 为没有考上大学的人的$\delta_i$ 的平均值，两个人没有考上大学，得到 $\delta_{ATU}=200$。

## 变换表达式

$$\delta_{ATT}=E(Y_i^1|D_i=1)-E(Y_i^0|D_i=1)$$

$$\delta_{ATU}=E(Y_i^1|D_i=0)-E(Y_i^0|D_i=0)$$

$$\delta_{ATE}=p\times \delta_{ATE}+(1-p)\delta_{ATU}$$

$$P=P(D_i=1)$$

从上述公式中，我们可以出，ATE实际上是 ATT 和 ATU 的加权平均，其权重分别为干预组和控制组在总体中所占的比重。

因此，要计算 ATE，只要求得 ATT 和 ATU 即可。

对 ATT 和 ATU 来说，它们可以分被通过两个期望值之差计算得到。因此，如果能够算出这些期望值，就可以得到 ATT 和 ATU，进而得到 ATE。

# 如何算出期望值

上述数据能提供什么？

在数据中，我们能够观察到因变量的实际观测值 $Y_i$ 以及干预变量 $D_i$，根据这些信息，我们能计算出干预组中 $Y_i$ 的期望值：$E(Y_i|D_i=1)$ 和控制组中 $Y_i$ 的期望值：$E(Y_i|D_i=0)$ .

我们知道，对那些上过大学的研究对象来说，$Y_i=Y_i^1$ ；而对那些没上过大学的研究对象来说，$Y_i=Y_i^0$ 。

因此，$Y_i$ 可通过一下公式来表示：

$$Y_i=D_i\times Y_i^1+ (1-D_i)\times Y_i^0$$

根据上述公式我们可以推断出：

$$E(Y_i|D_i=1)=E(Y_i^1|D_i=1)$$$$E(Y_i|D_i=0)=E(Y_i^0|D_i=0)$$

结合公式：

$$\delta_{ATT}=E(Y_i^1|D_i=1)-E(Y_i^0|D_i=1)$$

可以知道，计算 ATT 所需的两个期望值有一个是可以直接从数据中得到的，但另一个即 $E(Y_i^0|D_i=1)$ 却依然未知。

同理，将如下两个公式结合：

$$\delta_{ATU}=E(Y_i^1|D_i=0)-E(Y_i^0|D_i=0)$$
$$E(Y_i|D_i=0)=E(Y_i^0|D_i=0)$$
只需要进一步得到 $E(Y_i^1|D_i=0)$ 就可以算出 ATU。

这两个量都无法直接从数据得到，因此，我们必须做假定，其中最关键的一个假定就是可忽略性假定（ignorability assumption）。