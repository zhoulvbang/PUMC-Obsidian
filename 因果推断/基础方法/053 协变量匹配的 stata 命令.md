#Stata #常用命令 #使用技巧 
# 命令介绍

Stata 中实现精确匹配和马氏匹配的命令是 `teffects nnmatch`，它的语法结构如下：

```stata
teffects nnmatch (ovar omvarlist) (tvar) [if] [in] lweight] [, options1]
```

其中，`eftecis nnmatch`是命令名；其后第一个小括号中的 `ovar` 是研究的因变量，`omvanlist` 是需要匹配的协变量；第二个小括号中的 `var` 是干预变量。`in` 和 `weight` 的用法与其他命令相同，此处不再赘述。

该命令有以下几个常用选项：

- `ate`:估计 ATE,这是软件默认的输出结果。
- `atet`:估计 ATT。
- `ematch(varlist)`：对 `varlist` 中列出的变量实施精确匹配，默认对所有协变量实施马氏匹配。
- `biasadj(vartlist)`：在马氏匹配之后对 `varlist` 中列出的变量进行偏差校正。
- `nneighbor(#)`：采用 `1` 对 `#` 匹配，默认为 `1` 对 `1` 匹配，即 `nneighbor(1)`。
- `vce(vcetype)`：设置标准误计算方式。建议使用 `vce(robust, nn(#))`，该
选项表示采用阿巴迪和因本斯提出的 `1` 对 `#` 马氏匹配的稳健标准误，其中 `nn(#)` 的设定与选项 `nneighbor(#)`保持一致。
- `osample(newvar)`：对那些不满足匹配要求的个案进行标记，标记结果保存在变量 `newvar` 之中。
- `generate(stub)`：生成变量 `stub`, 以标记匹配个案的编号。
- `metric(metric)`:设置距离计算方式，默认为马氏距离。若要使用欧氏匝离，使用选项 `metric(euclidean)`；若要使用标准化后的欧氏距离，使用选项 `metric(ivariance)`。
- `level(#)`：设置置信区间的置信度，默认为95%， 即 `level(95)`。
- `control()`:设置与控制组对应的干预变量的取值，默认以取值为0的那一类作为控制组。
- `tlevel()`:设置与干预组对应的干预变量的取值，默认以取值为1的期一类作为干预组。

对于相化精确四配，目前还没有可供使用的官方命令。用户可通过以下命令下载程序包 `cem`,然后使用该程序包执行粗化精确匹配：

```stata
ssc install cem, replace
```

`cem`程序包中有两个命令。一是 `cem`,使用它可以实现粗化精确匹配，其语法结构如下：

```stata
cem varname1 [(cutpoints1)] [varname2 [(cutpoints2)]] ... [if] [in] [, options]
```

其中，`cem` 是命令名，其后的 `varname1`、`varname2` 等是协变量，用户可以在协变量之后的括号中设定针对该变量进行粗化所需的分割点，如 `age(10 20 30 40 50)` 表示将 `age` 粗化为6类：10以下为第1类，10—20为第2类，20—30为第3类，30-40为第4类，40-50为第5类，50以上为第6类。

如果要将变量粗化为规模相等的 `g` 个类别，可以在括号中使用 `#g`，如 `age(#6)`表示将 age 粗化为规模相等的6类。

如果不希望对该变量进行粗化，可以使用 `#0`，如 `age(#0)` 表示保留 `age` 的原始取值实施精确匹配。需要注意的是，用户可以通过上文所示的方式自己定义对协变量的粗化方法，也可以让软件基于算法对变量进行自动粗化。如果用户选择了后者，那么只需列出变量名即可。

`cem` 有以下几个常用的选项：

- `treatment(varname)`：设置干预变量，其变量名为 `varname`。
- `showbreaks`:显示对每个变量进行粗化时使用的分割点。
- `autocuts(string)`：设置自动粗化的算法，默认为 `autocuts(sturges)`，此外还有 `autocuts(fd)`、`autocuts(scott)`和 `autocuts(ss)`这三个选项可选。
- `k2k`：表示在每个匹配层中干预组个案与控制组个案数量不等的情况下随机删除部分个案以使其数量相等，采用这种方法的好处是在后续分析过程中不需要加权，但会因此损失样本量。建议用户使用 `cem` 输出的权重以保留最大样本量进行分析。

在使用 `cem` 命令执行粗化精确匹配之后，Stata 会自动生成以下三个变量：

- `cem_matched`:标识个案是否得到匹配。
- `cem_strata`:标识个案所在的匹配层号。
- `cem_weights`:权重，该权重可以直接应用到 `regress` 等命令中执行加权后的统计分析。

`cem` 程序包中的另一个命令是 `imb`,使用它可以计算布莱克韦尔等学者提出的测量干预组和控制组在协变量上不平衡程度的 $L_1$，其语法结构如下：

```stata
imb varlist [ifl [in][, options]
```

其中，`imb` 是命令名，`varlist` 是协变量的名称，它主要有两个选项：

- `treatment(varname)`：设置干预变量，其变量名为 `varname`。
- `useweights` :使用 `cem` 生成的权重 `cem_weights` 评估匹配后干预组和控制组在原始协变量上的不平衡性。

# 二、案例展示

接下来，我们将使用 cfps2010.dta 这个数据演示上述命令的使用方法。对该数据基本情况的介绍请参见第四章第五节。

与第四章演示线性回归时相同，本章分析的因变量仍为 `lninc`，干预变量为 `college`。

一元线性回归结果显示，在不控制任何变量的情况下，`college` 对 `lninc` 的回归系数为 0.824，这意味着，考上大学的样本和没有考上大学的样本在 `lninc` 上的均值差为 0.824。不过，考虑到这两个子样本在 `hukou`、`age`、`gender`、`race`、`sib-ling` 和 `fmedu` 这几个协变量上存在很大差异，上述结果很可能是有偏的。

下面，我们将通过匹配法来校正干预组和控制组在这些协变量上的差异。